# Multi-Session Architecture Design

## ğŸ¯ è®¾è®¡ç›®æ ‡

æ”¯æŒçœŸæ­£çš„ multi-session å’Œ multi-agent åœºæ™¯ï¼š
1. **å¤šä¼šè¯å¹¶å‘** - ç”¨æˆ·å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªç‹¬ç«‹çš„ Claude ä¼šè¯
2. **ä¼šè¯éš”ç¦»** - æ¯ä¸ªä¼šè¯æœ‰ç‹¬ç«‹çš„çŠ¶æ€ã€æ¶ˆæ¯æµå’Œæƒé™è¯·æ±‚
3. **å®¢æˆ·ç«¯è®¢é˜…æ¨¡å‹** - å‰ç«¯æŒ‰éœ€è®¢é˜…æ„Ÿå…´è¶£çš„ä¼šè¯
4. **èµ„æºé«˜æ•ˆ** - åªå‘å…³å¿ƒè¯¥ä¼šè¯çš„å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯

## ğŸ” å½“å‰æ¶æ„é—®é¢˜

### é—®é¢˜ 1: å…¨å±€å¹¿æ’­æ¨¡å¼
```typescript
// å½“å‰: WebSocketService å‘æ‰€æœ‰å®¢æˆ·ç«¯å¹¿æ’­æ‰€æœ‰äº‹ä»¶
broadcast(event: ServerEvent) {
  for (const client of this.clients) {
    ws.send(payload);  // æ‰€æœ‰å®¢æˆ·ç«¯éƒ½æ”¶åˆ°æ‰€æœ‰ä¼šè¯çš„æ¶ˆæ¯
  }
}
```

**é—®é¢˜**: å½“æœ‰å¤šä¸ªä¼šè¯åŒæ—¶è¿è¡Œæ—¶ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯ä¼šæ”¶åˆ°æ‰€æœ‰ä¼šè¯çš„æ¶ˆæ¯ï¼Œå¯¼è‡´ï¼š
- æ¶ˆæ¯æ··ä¹±
- å¸¦å®½æµªè´¹
- å‰ç«¯éœ€è¦è¿‡æ»¤å¤§é‡æ— å…³æ¶ˆæ¯

### é—®é¢˜ 2: å•ä¸€æ´»è·ƒä¼šè¯å‡è®¾
```typescript
// å‰ç«¯ store å‡è®¾åªæœ‰ä¸€ä¸ªæ´»è·ƒä¼šè¯
activeSessionId: string | null;
pendingStart: boolean;  // å…¨å±€çŠ¶æ€ï¼Œæ— æ³•åŒºåˆ†æ˜¯å“ªä¸ªä¼šè¯åœ¨å¯åŠ¨
```

**é—®é¢˜**: æ— æ³•åŒæ—¶è·Ÿè¸ªå¤šä¸ªæ­£åœ¨è¿è¡Œçš„ä¼šè¯

### é—®é¢˜ 3: çŠ¶æ€åŒæ­¥å›°éš¾
å½“ç”¨æˆ·åœ¨ Home é¡µé¢å¯åŠ¨æ–°ä¼šè¯æ—¶ï¼Œä¾èµ– `pendingStart` çŠ¶æ€æ¥è§¦å‘é¡µé¢è·³è½¬ï¼Œä½†è¿™ä¸ªçŠ¶æ€æ˜¯å…¨å±€çš„ã€‚

## ğŸ“ æ–°æ¶æ„è®¾è®¡

### æ ¸å¿ƒæ¦‚å¿µ

#### 1. å®¢æˆ·ç«¯è®¢é˜…æ¨¡å‹ (Subscription Model)

æ¯ä¸ª WebSocket å®¢æˆ·ç«¯å¯ä»¥è®¢é˜…å¤šä¸ªä¼šè¯ï¼Œåªæ¥æ”¶è®¢é˜…ä¼šè¯çš„äº‹ä»¶ã€‚

```typescript
// å®¢æˆ·ç«¯è®¢é˜…çŠ¶æ€
interface ClientSubscription {
  clientId: string;
  subscribedSessions: Set<string>;  // è®¢é˜…çš„ä¼šè¯ ID åˆ—è¡¨
  ws: WebSocket;
}
```

#### 2. äº‹ä»¶è·¯ç”± (Event Routing)

```typescript
class WebSocketService {
  private clients = new Map<string, ClientSubscription>();

  // è®¢é˜…ä¼šè¯
  subscribe(clientId: string, sessionId: string): void {
    const client = this.clients.get(clientId);
    if (client) {
      client.subscribedSessions.add(sessionId);
    }
  }

  // å–æ¶ˆè®¢é˜…
  unsubscribe(clientId: string, sessionId: string): void {
    const client = this.clients.get(clientId);
    if (client) {
      client.subscribedSessions.delete(sessionId);
    }
  }

  // å‘è®¢é˜…äº†ç‰¹å®šä¼šè¯çš„å®¢æˆ·ç«¯å‘é€äº‹ä»¶
  sendToSession(sessionId: string, event: ServerEvent): void {
    for (const [, client] of this.clients) {
      if (client.subscribedSessions.has(sessionId)) {
        client.ws.send(JSON.stringify(event));
      }
    }
  }

  // å‘æ‰€æœ‰å®¢æˆ·ç«¯å¹¿æ’­ï¼ˆç”¨äºå…¨å±€äº‹ä»¶å¦‚ session.listï¼‰
  broadcast(event: ServerEvent): void {
    for (const [, client] of this.clients) {
      client.ws.send(JSON.stringify(event));
    }
  }
}
```

### æ–°çš„äº‹ä»¶ç±»å‹

#### Client â†’ Server Events

```typescript
type ClientEvent =
  // ä¼šè¯ç®¡ç†
  | { type: "session.start"; payload: { prompt: string; cwd?: string; title?: string } }
  | { type: "session.continue"; payload: { sessionId: string; prompt: string } }
  | { type: "session.stop"; payload: { sessionId: string } }
  | { type: "session.delete"; payload: { sessionId: string } }

  // è®¢é˜…ç®¡ç†
  | { type: "session.subscribe"; payload: { sessionId: string } }
  | { type: "session.unsubscribe"; payload: { sessionId: string } }

  // æ•°æ®è¯·æ±‚
  | { type: "session.list" }
  | { type: "session.history"; payload: { sessionId: string } }

  // æƒé™å“åº”
  | { type: "permission.response"; payload: { sessionId: string; toolUseId: string; result: PermissionResult } };
```

#### Server â†’ Client Events

```typescript
type ServerEvent =
  // ä¼šè¯çŠ¶æ€
  | { type: "session.created"; payload: { session: SessionInfo } }  // æ–°å¢ï¼šä¼šè¯åˆ›å»ºå®Œæˆ
  | { type: "session.status"; payload: { sessionId: string; status: SessionStatus; title?: string; cwd?: string; error?: string } }
  | { type: "session.list"; payload: { sessions: SessionInfo[] } }
  | { type: "session.history"; payload: { sessionId: string; status: SessionStatus; messages: StreamMessage[] } }
  | { type: "session.deleted"; payload: { sessionId: string } }

  // æ¶ˆæ¯æµï¼ˆåªå‘ç»™è®¢é˜…è€…ï¼‰
  | { type: "stream.message"; payload: { sessionId: string; message: StreamMessage } }
  | { type: "stream.user_prompt"; payload: { sessionId: string; prompt: string } }

  // æƒé™è¯·æ±‚ï¼ˆåªå‘ç»™è®¢é˜…è€…ï¼‰
  | { type: "permission.request"; payload: { sessionId: string; toolUseId: string; toolName: string; input: unknown } }

  // é”™è¯¯
  | { type: "runner.error"; payload: { sessionId?: string; message: string } };
```

### å‰ç«¯çŠ¶æ€ç®¡ç†é‡æ„

```typescript
interface AppState {
  // ä¼šè¯æ•°æ®
  sessions: Record<string, SessionView>;

  // è®¢é˜…çŠ¶æ€
  subscribedSessions: Set<string>;  // å½“å‰è®¢é˜…çš„ä¼šè¯

  // UI çŠ¶æ€
  activeSessionId: string | null;   // å½“å‰æŸ¥çœ‹çš„ä¼šè¯ï¼ˆä¸ä¸€å®šæ˜¯è¿è¡Œä¸­çš„ï¼‰

  // ç§»é™¤ pendingStartï¼Œæ”¹ç”¨æ›´ç²¾ç¡®çš„çŠ¶æ€
  pendingSessionStart: string | null;  // æ­£åœ¨å¯åŠ¨çš„ä¼šè¯ IDï¼ˆä¸´æ—¶ IDï¼‰

  // Actions
  subscribeToSession: (sessionId: string) => void;
  unsubscribeFromSession: (sessionId: string) => void;
}
```

### ä¼šè¯å¯åŠ¨æµç¨‹é‡æ„

#### å½“å‰æµç¨‹ï¼ˆæœ‰é—®é¢˜ï¼‰
```
1. ç”¨æˆ·ç‚¹å‡»å‘é€
2. å‰ç«¯è®¾ç½® pendingStart = true
3. å‰ç«¯å‘é€ session.start
4. åç«¯åˆ›å»ºä¼šè¯ï¼Œå‘é€ session.status (running)
5. å‰ç«¯æ”¶åˆ° session.statusï¼Œè®¾ç½® activeSessionIdï¼Œæ¸…é™¤ pendingStart
6. Home é¡µé¢æ£€æµ‹ pendingStart å˜åŒ–ï¼Œè·³è½¬åˆ° chat é¡µé¢
```

é—®é¢˜ï¼šå¦‚æœåŒæ—¶å¯åŠ¨å¤šä¸ªä¼šè¯ï¼ŒpendingStart ä¼šæ··ä¹±

#### æ–°æµç¨‹
```
1. ç”¨æˆ·ç‚¹å‡»å‘é€
2. å‰ç«¯ç”Ÿæˆä¸´æ—¶ ID (tempId)ï¼Œè®¾ç½® pendingSessionStart = tempId
3. å‰ç«¯å‘é€ session.start { tempId, prompt, cwd }
4. åç«¯åˆ›å»ºä¼šè¯ï¼Œè¿”å› session.created { session, tempId }
5. å‰ç«¯æ”¶åˆ° session.createdï¼š
   - å¦‚æœ tempId åŒ¹é… pendingSessionStartï¼Œè·³è½¬åˆ° /chat/{sessionId}
   - è‡ªåŠ¨è®¢é˜…è¯¥ä¼šè¯
   - æ¸…é™¤ pendingSessionStart
6. åç«¯å¼€å§‹è¿è¡Œä¼šè¯ï¼Œå‘é€ session.status (running)
7. å‰ç«¯æ›´æ–°ä¼šè¯çŠ¶æ€
```

### æ¶æ„åˆ†å±‚å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Home      â”‚  â”‚   Chat      â”‚  â”‚   SessionList           â”‚ â”‚
â”‚  â”‚  (åˆ›å»ºä¼šè¯) â”‚  â”‚ (æŸ¥çœ‹/äº¤äº’) â”‚  â”‚   (ä¼šè¯åˆ—è¡¨)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚               â”‚                    â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    useAppStore                               â”‚â”‚
â”‚  â”‚  - sessions: Record<id, SessionView>                        â”‚â”‚
â”‚  â”‚  - subscribedSessions: Set<string>                          â”‚â”‚
â”‚  â”‚  - handleServerEvent()                                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                         â”‚                                        â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                   useWebSocket                               â”‚â”‚
â”‚  â”‚  - ç®¡ç† WebSocket è¿æ¥                                       â”‚â”‚
â”‚  â”‚  - å‘é€/æ¥æ”¶äº‹ä»¶                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                         WebSocket
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Backend                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                 WebSocketController                          â”‚â”‚
â”‚  â”‚  - handleClientEvent()                                       â”‚â”‚
â”‚  â”‚  - è·¯ç”±äº‹ä»¶åˆ°å¯¹åº” Service                                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                         â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â†“               â†“               â†“                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚SessionServiceâ”‚ â”‚ClaudeServiceâ”‚ â”‚WebSocketSvc â”‚               â”‚
â”‚  â”‚ - CRUD      â”‚ â”‚ - run()     â”‚ â”‚ - è®¢é˜…ç®¡ç†  â”‚               â”‚
â”‚  â”‚ - å¯åŠ¨/åœæ­¢ â”‚ â”‚ - abort()   â”‚ â”‚ - äº‹ä»¶è·¯ç”±  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â”‚               â”‚               â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    Repository Layer                          â”‚â”‚
â”‚  â”‚  SessionRepository, MessageRepository                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                         â”‚                                        â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                     SQLite (Drizzle)                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¤šä¼šè¯è¿è¡Œç¤ºä¾‹

```
ç”¨æˆ·åœºæ™¯ï¼š
- ä¼šè¯ A: æ­£åœ¨è¿è¡Œä»£ç åˆ†æä»»åŠ¡
- ä¼šè¯ B: ç­‰å¾…ç”¨æˆ·å›ç­”é—®é¢˜
- ä¼šè¯ C: å·²å®Œæˆ

å‰ç«¯çŠ¶æ€ï¼š
{
  sessions: {
    "a": { status: "running", messages: [...] },
    "b": { status: "running", permissionRequests: [...] },
    "c": { status: "completed", messages: [...] }
  },
  subscribedSessions: new Set(["a", "b"]),  // åªè®¢é˜…äº† A å’Œ B
  activeSessionId: "b"  // å½“å‰æŸ¥çœ‹ B
}

WebSocket æ¶ˆæ¯æµï¼š
- ä¼šè¯ A çš„ stream.message â†’ å‘ç»™è®¢é˜…äº† A çš„å®¢æˆ·ç«¯
- ä¼šè¯ B çš„ permission.request â†’ å‘ç»™è®¢é˜…äº† B çš„å®¢æˆ·ç«¯
- ä¼šè¯ C çš„æ¶ˆæ¯ â†’ ä¸å‘é€ï¼ˆæ— äººè®¢é˜…ï¼‰
```

## ğŸ”„ è¿ç§»è®¡åˆ’

### Phase 1: WebSocketService æ”¹é€ 
1. æ·»åŠ å®¢æˆ·ç«¯è®¢é˜…ç®¡ç†
2. å®ç° `sendToSession()` æ–¹æ³•
3. æ·»åŠ  `session.subscribe` / `session.unsubscribe` äº‹ä»¶å¤„ç†

### Phase 2: äº‹ä»¶ç±»å‹æ›´æ–°
1. æ·»åŠ  `session.created` äº‹ä»¶
2. åœ¨ `session.start` ä¸­æ”¯æŒ `tempId`
3. æ›´æ–° TypeScript ç±»å‹å®šä¹‰

### Phase 3: å‰ç«¯çŠ¶æ€é‡æ„
1. æ·»åŠ  `subscribedSessions` çŠ¶æ€
2. ç”¨ `pendingSessionStart` æ›¿æ¢ `pendingStart`
3. æ›´æ–° Home é¡µé¢è·³è½¬é€»è¾‘

### Phase 4: è‡ªåŠ¨è®¢é˜…é€»è¾‘
1. åˆ›å»ºä¼šè¯æ—¶è‡ªåŠ¨è®¢é˜…
2. è¿›å…¥ chat é¡µé¢æ—¶è‡ªåŠ¨è®¢é˜…
3. ç¦»å¼€ chat é¡µé¢æ—¶å¯é€‰å–æ¶ˆè®¢é˜…

## ğŸ“ API å˜æ›´æ‘˜è¦

### æ–°å¢äº‹ä»¶
- `session.created` - ä¼šè¯åˆ›å»ºå®Œæˆï¼Œè¿”å›ä¼šè¯ä¿¡æ¯å’Œ tempId
- `session.subscribe` - å®¢æˆ·ç«¯è®¢é˜…ä¼šè¯
- `session.unsubscribe` - å®¢æˆ·ç«¯å–æ¶ˆè®¢é˜…

### ä¿®æ”¹äº‹ä»¶
- `session.start` - æ·»åŠ å¯é€‰çš„ `tempId` å­—æ®µ

### å‰ç«¯çŠ¶æ€å˜æ›´
- æ–°å¢ `subscribedSessions: Set<string>`
- ä¿®æ”¹ `pendingStart: boolean` â†’ `pendingSessionStart: string | null`

## âœ… é¢„æœŸæ•ˆæœ

1. **çœŸæ­£çš„å¤šä¼šè¯æ”¯æŒ**: å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªä¼šè¯ï¼Œäº’ä¸å¹²æ‰°
2. **ç²¾ç¡®çš„æ¶ˆæ¯æŠ•é€’**: åªå‘å…³å¿ƒçš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
3. **æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ**: ç”¨æˆ·å¯ä»¥åœ¨å¤šä¸ªä¼šè¯é—´åˆ‡æ¢ï¼Œä¸ä¼šä¸¢å¤±è¿›åº¦
4. **èµ„æºä¼˜åŒ–**: å‡å°‘ä¸å¿…è¦çš„æ¶ˆæ¯ä¼ è¾“
5. **æ‰©å±•æ€§**: ä¸ºæœªæ¥çš„ multi-agent åœºæ™¯æ‰“å¥½åŸºç¡€
